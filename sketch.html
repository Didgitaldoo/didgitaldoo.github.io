---
layout: default
title: Sketch
---
<div class="container mt-4">

  <h1 class="text-center mb-4">Didgeridoo Shape Analyzer</h1>

  <!-- just enough to get the text area and the buttons to be in the same row -->
  <div class="d-flex gap-5">
    <select id="shapeSelect" class="form-select">
      <option value="arusha_1">Arusha 1</option>
      <option value="arusha_2">Arusha 2</option>
      <option value="kizimazi">Kizimazi</option>
      <option value="matema">Matema</option>
    </select>
    <button onclick="fetchShape()" class="btn btn-primary mt-1">Load Shape</button>
  </div>

  <div class="mb-3">
    <form id="didgeForm" class="mt-4">
      <label for="geoInput" class="form-label">
        Enter Geometry: position diameter ( in mm)
      </label>

      <textarea id="geoInput" class="form-control" rows="6">0 28 &#10;100 26 &#10;1400 38 &#10;
      </textarea>
      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-success mt-3">Analyze</button>
    </form>
    <div class="savebtn mt-3">
      <button type="submit" class="btn btn-primary">Save</button>
    </div>

    <div class="loadbtn mt-3">
      <button type="submit" class="btn btn-primary">Load</button>
    </div>

  </div>

  <hr>
  <div id="results" class="hidden mt-5">
    <h2>Results</h2>

    <p><strong>Mouthpiece Diameter:</strong> <span id="mouthpiece"></span> mm</p>
    <p><strong>Didgeridoo Length:</strong> <span id="length"></span> mm</p>

    <strong>Tuning</strong> <span id="notes"></span>

    <h3 class="mt-4">Shape</h3>
    <img id="shapeImg" class="img-fluid" alt="Shape" />

    <h3 class="mt-4">Impedance Spectrum</h3>
    <img id="impedanceImg" class="img-fluid" alt="Impedance Spectrum" />

    <h3 class="mt-4">Sound Spectrum</h3>
    <img id="soundImg" class="img-fluid" alt="Sound Spectrum" />
  </div>
</div>

<script>

  let apiUrl = "https://didge-calc.ktano-studio.com";
  //let apiUrl = "http://localhost:8000";

  document.getElementById("didgeForm").addEventListener("submit", async function (event) {
    event.preventDefault();

    let geoInput = document.getElementById("geoInput").value.trim();

    let geoData = geoInput.split("\n").map(line => {
      let parts = line.trim().split(/\s+/);
      if (parts.length !== 2) {
        alert("Invalid format! Each line must have exactly two numbers.");
        throw new Error("Invalid format");
      }

      if (parts[0].includes(".") || parts[1].includes(".")) {
        alert("Sorry no decimals allowed for now.");
        throw new Error("Invalid format");
      }
      return [parseFloat(parts[0]), parseFloat(parts[1])];
    });


    let response = await fetch(apiUrl + "/analyze_didge", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({geo: geoData})
    });

    if (!response.ok) {
      alert("Error connecting to the API.");
      return; h
    }

    let result = await response.json();

    document.getElementById("mouthpiece").textContent = result.mouthpiece_diameter_mm;
    document.getElementById("length").textContent = result.didgeridoo_length_mm;
    document.getElementById("notes").textContent = result.notes;

    document.getElementById("impedanceImg").src = "data:image/png;base64," + result.impedance_plot;
    document.getElementById("soundImg").src = "data:image/png;base64," + result.sound_spectrum_plot;
    document.getElementById("shapeImg").src = "data:image/png;base64," + result.shape_plot;

    document.querySelector(".savebtn").addEventListener("click", function () {
      var textToSave = geoInput;
      var hiddenElement = document.createElement('a');

      hiddenElement.href = 'data:attachment/text,' + encodeURI(textToSave);
      hiddenElement.target = '_blank';
      hiddenElement.download = 'didgeridoo.txt';
      hiddenElement.click();
    });

    document.querySelector(".loadbtn").addEventListener("click", function () {
      var fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.txt';
      fileInput.click();

      fileInput.addEventListener('change', function () {
        var file = fileInput.files[0];
        var reader = new FileReader();

        reader.onload = function (e) {
          var text = reader.result;
          document.getElementById("geoInput").value = text;
        };
        reader.readAsText(file);
      });
    });

    document.getElementById("results").classList.remove("hidden");
    displayNotesTable(result.notes);
  });

  function displayNotesTable(notes) {
    let notesContainer = document.getElementById("notes");
    notesContainer.innerHTML = "";

    let table = document.createElement("table");

    let tbody = document.createElement("tbody");
    let keysToDisplay = ["freq", "note-name", "cent-diff"];

    let freqKeys = Object.keys(notes["freq"]);

    keysToDisplay.forEach(category => {

      let row = document.createElement("tr");

      let tdCategory = document.createElement("td");
      tdCategory.textContent = category;
      row.appendChild(tdCategory);

      let values = freqKeys.map(key => notes[category][key]);
      values.unshift(values.pop());

      values.forEach(value => {
        let tdValue = document.createElement("td");

        if (category === "cent-diff" || category === "freq") {
          value = parseFloat(value).toFixed(2);
        }

        tdValue.textContent = value;
        row.appendChild(tdValue);
      });

      tbody.appendChild(row);
    });

    table.appendChild(tbody);
    notesContainer.appendChild(table);
  }

  function fetchShape() {

    let shape_name = document.getElementById("shapeSelect").value;

    fetch(apiUrl + "/fetch_shape/" + shape_name)
      .then(response => response.json())
      .then(data => {
        let geo = data.geo.map(point => point.join(" ")).join("\n");
        document.getElementById("geoInput").value = geo;
      });
  }

</script>
